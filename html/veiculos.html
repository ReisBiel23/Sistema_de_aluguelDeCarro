<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ve√≠culos - CarRental</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <style>
      /* P√°gina: ajustes visuais */
      :root{
        --card-bg: #ffffff;
        --muted: #6b7280;
        --accent: #2563eb;
        --surface: #f8fafc;
        --radius: 10px;
      }
      body { background: var(--surface); }

      .page-actions {
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
        margin-bottom:16px;
      }
      .page-actions .title-block h2 { margin:0; font-size:1.25rem; }
      .page-actions .title-block p { margin:0; color:var(--muted); font-size:0.95rem; }

      /* Grid cards */
      .vehicles-grid {
        display:grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap:16px;
      }
      .vehicle-card {
        background: linear-gradient(180deg,#fff,#fbfdff);
        border: 1px solid rgba(15,23,42,0.04);
        border-radius:var(--radius);
        padding:12px;
        box-shadow: 0 4px 20px rgba(2,6,23,0.03);
        display:flex;
        flex-direction:column;
        gap:8px;
        min-height:260px;
      }
      .vehicle-image {
        width:100%;
        height:140px;
        object-fit:cover;
        border-radius:8px;
        background:#eef2ff;
      }
      .vehicle-info { display:flex; flex-direction:column; gap:6px; flex:1; }
      .vehicle-title { font-weight:700; font-size:1rem; margin:0; }
      .vehicle-sub { color:var(--muted); font-size:0.9rem; margin:0; }

      .vehicle-meta { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:auto; }
      .status-badge { padding:6px 10px; border-radius:999px; font-size:0.85rem; font-weight:600; }
      .status-available { background:#ecfdf5; color:#065f46; }
      .status-unavailable { background:#fff1f2; color:#9f1239; }

      .card-actions { display:flex; gap:8px; align-items:center; }

      /* FAB for admin add */
      .fab {
        position:fixed;
        right:24px;
        bottom:24px;
        width:56px;
        height:56px;
        border-radius:50%;
        background:var(--accent);
        color:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:24px;
        cursor:pointer;
        box-shadow: 0 8px 24px rgba(37,99,235,0.18);
        z-index:150;
      }

      /* Modals */
      .modal {
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        background:rgba(2,6,23,0.45);
        z-index:200;
        padding:20px;
      }
      .modal.active { display:flex; }
      .modal-dialog {
        width:100%;
        max-width:900px;
        background:var(--card-bg);
        border-radius:12px;
        padding:18px;
        box-shadow: 0 10px 40px rgba(2,6,23,0.12);
      }
      .modal-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
      .modal-body { max-height:60vh; overflow:auto; }
      .modal-close { background:none; border:none; font-size:20px; cursor:pointer; }

      /* Admin table */
      .admin-table { width:100%; border-collapse: collapse; }
      .admin-table th, .admin-table td { padding:10px 8px; border-bottom:1px solid rgba(15,23,42,0.04); text-align:left; }
      .admin-table img { width:96px; height:64px; object-fit:cover; border-radius:6px; }

      /* Forms inside modal */
      .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
      .img-preview { width:160px; height:110px; object-fit:cover; border-radius:8px; background:#eef2ff; display:block; }

      .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:#fff; }
      .btn-outline { background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); }
      .btn-danger { background:#dc2626; }
      .muted { color:var(--muted); }

      @media (max-width:720px){
        .vehicles-grid { grid-template-columns: repeat(1, 1fr); }
        .modal-dialog { max-width:95%; padding:12px; }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-layout">
      <!-- Sidebar (reuse your sidebar; keep data-role attributes) -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">üöó CarRental</div>
        </div>

        <nav class="sidebar-nav" aria-label="Navega√ß√£o principal">
          <div class="nav-section">
            <div class="nav-section-title">Menu</div>

            <a href="dashboard.html" class="nav-link" data-role="admin,client">
              <span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span>
            </a>
            <a href="veiculos.html" class="nav-link active" data-role="admin,client">
              <span class="nav-icon">üöó</span><span class="nav-text">Ve√≠culos</span>
            </a>
            <a href="pedidos.html" class="nav-link" data-role="client">
              <span class="nav-icon">üìã</span><span class="nav-text">Meus Pedidos</span>
            </a>
            <a href="gerenciar-pedidos.html" class="nav-link" data-role="admin">
              <span class="nav-icon">üõ†Ô∏è</span><span class="nav-text">Gerenciar Pedidos</span>
            </a>
            <a href="contratos.html" class="nav-link" data-role="admin,client">
              <span class="nav-icon">üìÑ</span><span class="nav-text">Contratos</span>
            </a>
          </div>

          <div class="nav-section">
            <div class="nav-section-title">Conta</div>

            <a href="perfil.html" class="nav-link" data-role="admin,client">
              <span class="nav-icon">üë§</span><span class="nav-text">Perfil</span>
            </a>

            <a href="#" id="logoutBtn" class="nav-link">
              <span class="nav-icon">üö™</span><span class="nav-text">Sair</span>
            </a>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="user-profile">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
              <div class="user-name" id="userName">Usu√°rio</div>
              <div class="user-role" id="userRole">‚Äî</div>
            </div>
          </div>
        </div>
      </aside>

      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <main class="main-content">
        <header class="topbar">
          <div class="topbar-left">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <h1 class="page-title">Ve√≠culos</h1>
          </div>
        </header>

        <div class="content">
          <div class="page-actions">
            <div class="title-block">
              <h2>Ve√≠culos</h2>
              <p class="muted">Administradores podem cadastrar/editar. Clientes visualizam e solicitam ve√≠culos dispon√≠veis.</p>
            </div>

            <div class="actions-right">
              <!-- Admin: bot√£o flutante tamb√©m ficar√° vis√≠vel -->
              <button class="btn btn-outline" id="openAdminPanel" data-role="admin" title="Abrir painel de ger√™ncia">Painel Admin</button>
            </div>
          </div>

          <!-- Grid of vehicles for clients and neutral viewing -->
          <div id="vehiclesArea">
            <div id="vehiclesGrid" class="vehicles-grid" aria-live="polite"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Floating Add (admin only) -->
    <button class="fab" id="fabAdd" title="Adicionar ve√≠culo" data-role="admin">+</button>

    <!-- Vehicle Detail Modal -->
    <div class="modal" id="viewModal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
        <div class="modal-header">
          <div>
            <h3 id="viewModalTitle">Detalhes do Ve√≠culo</h3>
            <div class="muted" id="viewSub"></div>
          </div>
          <button class="modal-close" id="viewClose">&times;</button>
        </div>
        <div class="modal-body" id="viewBody">
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <img id="viewImg" style="width:320px;height:200px;object-fit:cover;border-radius:8px" alt="Imagem do ve√≠culo" />
            <div style="flex:1;">
              <p id="viewInfo" class="muted"></p>
              <p id="viewPrice" style="font-weight:700;font-size:1.05rem"></p>
              <div id="viewActions" style="margin-top:12px;display:flex;gap:8px"></div>
            </div>
          </div>
          <div style="margin-top:12px" id="viewExtra"></div>
        </div>
      </div>
    </div>

    <!-- Admin Add/Edit Modal -->
    <div class="modal" id="adminModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-header">
          <h3 id="adminModalTitle">Novo Ve√≠culo</h3>
          <button class="modal-close" id="adminClose">&times;</button>
        </div>
        <div class="modal-body">
          <form id="vehicleForm">
            <input type="hidden" id="vehicleId" />
            <div class="form-grid">
              <div>
                <label class="form-label">Marca</label>
                <input id="brand" name="brand" class="form-input" required />
              </div>
              <div>
                <label class="form-label">Modelo</label>
                <input id="model" name="model" class="form-input" required />
              </div>
              <div>
                <label class="form-label">Ano</label>
                <input id="year" name="year" type="number" class="form-input" min="1900" max="2099" required />
              </div>
              <div>
                <label class="form-label">Placa</label>
                <input id="plate" name="plate" class="form-input" required />
              </div>
              <div>
                <label class="form-label">Pre√ßo por dia (R$)</label>
                <input id="price" name="price" type="number" step="0.01" class="form-input" />
              </div>
              <div>
                <label class="form-label">Status</label>
                <select id="statusSelect" class="form-select">
                  <option value="available">Dispon√≠vel</option>
                  <option value="unavailable">Indispon√≠vel</option>
                </select>
              </div>
              <div>
                <label class="form-label">Foto</label>
                <input id="imageInput" type="file" accept="image/*" class="form-input" />
              </div>
              <div>
                <label class="form-label">Preview</label>
                <img id="imagePreview" class="img-preview" alt="Preview" />
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
              <button type="button" class="btn btn-outline" id="adminCancel">Cancelar</button>
              <button type="submit" class="btn" id="adminSave">Salvar</button>
            </div>
          </form>

          <hr style="margin:14px 0" />

          <!-- Admin vehicles table -->
          <div id="adminTableWrap">
            <h4 style="margin-top:0">Ve√≠culos Cadastrados</h4>
            <div style="overflow:auto;max-height:260px;">
              <table class="admin-table" id="adminTable">
                <thead><tr><th>Foto</th><th>Marca / Modelo</th><th>Ano</th><th>Placa</th><th>Pre√ßo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal" id="confirmModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-header">
          <h3>Confirmar exclus√£o</h3>
          <button class="modal-close" id="confirmClose">&times;</button>
        </div>
        <div class="modal-body">
          <p class="muted">Tem certeza que deseja excluir este ve√≠culo? Esta a√ß√£o n√£o pode ser desfeita.</p>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
            <button class="btn btn-outline" id="confirmCancel">Cancelar</button>
            <button class="btn btn-danger" id="confirmDelete">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- scripts -->
    <script src="js/auth.js"></script>
    <script>
      (function(){
        // keys
        const VEHICLES_KEY = 'vehicles';
        const ORDERS_KEY = 'orders';

        // helpers
        function sampleVehicles(){
          return [
            { id: 'V-1', brand:'Toyota', model:'Corolla', year:2021, plate:'ABC-1234', price:150, status:'available', image:'' },
            { id: 'V-2', brand:'Honda', model:'Civic', year:2020, plate:'XYZ-5678', price:170, status:'available', image:'' },
            { id: 'V-3', brand:'Ford', model:'Ka', year:2019, plate:'KLM-9012', price:120, status:'unavailable', image:'' }
          ];
        }
        function loadVehicles(){
          try { const raw = localStorage.getItem(VEHICLES_KEY); return raw ? JSON.parse(raw) : (function(){ const s=sampleVehicles(); localStorage.setItem(VEHICLES_KEY,JSON.stringify(s)); return s; })(); }
          catch(e){ console.error(e); const s=sampleVehicles(); localStorage.setItem(VEHICLES_KEY,JSON.stringify(s)); return s; }
        }
        function saveVehicles(arr){ localStorage.setItem(VEHICLES_KEY, JSON.stringify(arr)); }
        function loadOrders(){ try { const r=localStorage.getItem(ORDERS_KEY); return r?JSON.parse(r):[]; } catch(e){ return []; } }
        function saveOrders(a){ localStorage.setItem(ORDERS_KEY, JSON.stringify(a)); }

        // UI refs
        const vehiclesGrid = document.getElementById('vehiclesGrid');
        const fabAdd = document.getElementById('fabAdd');
        const viewModal = document.getElementById('viewModal');
        const viewClose = document.getElementById('viewClose');
        const viewImg = document.getElementById('viewImg');
        const viewInfo = document.getElementById('viewInfo');
        const viewPrice = document.getElementById('viewPrice');
        const viewActions = document.getElementById('viewActions');
        const viewExtra = document.getElementById('viewExtra');
        const viewSub = document.getElementById('viewSub');

        const adminModal = document.getElementById('adminModal');
        const adminClose = document.getElementById('adminClose');
        const openAdminPanel = document.getElementById('openAdminPanel');
        const adminTableBody = document.querySelector('#adminTable tbody');
        const vehicleForm = document.getElementById('vehicleForm');
        const vehicleIdInput = document.getElementById('vehicleId');
        const brandInput = document.getElementById('brand');
        const modelInput = document.getElementById('model');
        const yearInput = document.getElementById('year');
        const plateInput = document.getElementById('plate');
        const priceInput = document.getElementById('price');
        const statusSelect = document.getElementById('statusSelect');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');

        const confirmModal = document.getElementById('confirmModal');
        const confirmClose = document.getElementById('confirmClose');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        let vehicles = [];
        let toDeleteId = null;

        // navigation / auth init on page load
        document.addEventListener('DOMContentLoaded', function(){
          if (!window.Auth) { console.error('Auth n√£o encontrado'); return; }

          // require login
          window.Auth.protectRoute();

          // apply role visibility across UI
          window.Auth.applyRoleVisibility();
          window.Auth.autoAttachLogout();

          // populate user info in sidebar
          const user = window.Auth.getCurrentUser();
          if (user) {
            const uName = user.name || user.email || 'Usu√°rio';
            const uRoleText = user.role === 'admin' ? 'Administrador' : 'Cliente';
            document.getElementById('userName').textContent = uName;
            document.getElementById('userRole').textContent = uRoleText;
            document.getElementById('userAvatar').textContent = (uName.charAt(0) || 'U').toUpperCase();
          }

          // hide/show FAB and admin panel button based on role (Auth.applyRoleVisibility will hide them visually if data-role used)
          // but ensure the controls are not active for clients:
          if (user && user.role !== 'admin') {
            fabAdd.style.display = 'none';
            openAdminPanel.style.display = 'none';
          }

          // load and render
          vehicles = loadVehicles();
          render();
        });

        // helpers
        function placeholderDataURL(){
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%' height='100%' fill='#eef2ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#94a3b8' font-size='24'>sem imagem</text></svg>`;
          return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        }
        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function fileToDataUrl(file){ return new Promise((res,rej)=>{ if(!file) return res(''); const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

        // render functions
        function render(){
          // build grid for everyone; clients will see only available when requesting
          vehiclesGrid.innerHTML = '';
          vehicles.forEach(v => {
            const card = document.createElement('div');
            card.className = 'vehicle-card';
            card.innerHTML = `
              <img class="vehicle-image" src="${v.image || placeholderDataURL()}" alt="${escapeHtml(v.brand+' '+v.model)}" />
              <div class="vehicle-info">
                <p class="vehicle-title">${escapeHtml(v.brand)} ${escapeHtml(v.model)}</p>
                <p class="vehicle-sub">${v.year} ‚Ä¢ ${escapeHtml(v.plate)}</p>
                <div class="vehicle-meta">
                  <div>${v.price ? 'R$ '+Number(v.price).toFixed(2) : '-'}</div>
                  <div>${v.status === 'available' ? '<span class="status-badge status-available">Dispon√≠vel</span>' : '<span class="status-badge status-unavailable">Indispon√≠vel</span>'}</div>
                </div>
                <div class="card-actions">
                  <button class="btn btn-outline" data-action="view" data-id="${v.id}">Detalhes</button>
                  ${ (window.Auth && window.Auth.getCurrentUser() && window.Auth.getCurrentUser().role === 'client' && v.status === 'available') ? `<button class="btn" data-action="rent" data-id="${v.id}">Solicitar</button>` : '' }
                </div>
              </div>
            `;
            vehiclesGrid.appendChild(card);
          });

          // attach click handlers
          vehiclesGrid.querySelectorAll('button[data-action="view"]').forEach(b => b.addEventListener('click', onView));
          vehiclesGrid.querySelectorAll('button[data-action="rent"]').forEach(b => b.addEventListener('click', onRent));
        }

        function refreshAdminTable(){
          if (!adminTableBody) return;
          adminTableBody.innerHTML = '';
          vehicles.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${v.image||placeholderDataURL()}" alt="" /></td>
              <td><strong>${escapeHtml(v.brand)} ${escapeHtml(v.model)}</strong><div class="muted">${escapeHtml(v.plate)}</div></td>
              <td>${v.year}</td>
              <td>${escapeHtml(v.plate)}</td>
              <td>${v.price ? 'R$ '+Number(v.price).toFixed(2) : '-'}</td>
              <td>${v.status === 'available' ? '<span class="status-badge status-available">Dispon√≠vel</span>' : '<span class="status-badge status-unavailable">Indispon√≠vel</span>'}</td>
              <td>
                <div style="display:flex;gap:6px;align-items:center">
                  <button class="btn btn-outline" data-act="edit" data-id="${v.id}">Editar</button>
                  <button class="btn btn-danger" data-act="del" data-id="${v.id}">Excluir</button>
                </div>
              </td>
            `;
            adminTableBody.appendChild(tr);
          });
          adminTableBody.querySelectorAll('button[data-act]').forEach(b => b.addEventListener('click', onAdminTableAction));
        }

        // actions
        function onView(ev){
          const id = ev.currentTarget.dataset.id;
          const v = vehicles.find(x=>x.id===id);
          if (!v) return;
          viewImg.src = v.image || placeholderDataURL();
          viewSub.textContent = `${v.brand} ${v.model}`;
          viewInfo.innerHTML = `Placa: <strong>${escapeHtml(v.plate)}</strong><br>Ano: <strong>${v.year}</strong>`;
          viewPrice.textContent = v.price ? 'R$ '+Number(v.price).toFixed(2)+' / dia' : '';
          viewExtra.innerHTML = '';
          viewActions.innerHTML = '';

          const user = window.Auth.getCurrentUser();
          if (user && user.role === 'client' && v.status === 'available') {
            const rent = document.createElement('button');
            rent.className = 'btn';
            rent.textContent = 'Solicitar Pedido';
            rent.addEventListener('click', function(){
              // create simple order
              const orders = loadOrders();
              const order = {
                id: 'P-' + Date.now(),
                vehicleId: v.id,
                client: user.name || user.email,
                email: user.email,
                vehicle: v.brand + ' ' + v.model,
                start: new Date().toISOString().slice(0,10),
                end: new Date(Date.now() + 2*24*3600*1000).toISOString().slice(0,10),
                status: 'Pendente'
              };
              orders.push(order);
              saveOrders(orders);
              alert('Pedido criado. O administrador ir√° analisar.');
              closeView();
            });
            viewActions.appendChild(rent);
          }
          if (user && user.role === 'admin') {
            const edit = document.createElement('button');
            edit.className = 'btn btn-outline';
            edit.textContent = 'Editar';
            edit.addEventListener('click', function(){
              openAdminModal(v.id);
            });
            viewActions.appendChild(edit);

            const del = document.createElement('button');
            del.className = 'btn btn-danger';
            del.textContent = 'Excluir';
            del.addEventListener('click', function(){
              toDeleteId = v.id;
              openConfirm();
            });
            viewActions.appendChild(del);
          }

          openView();
        }
        function onRent(ev){
          // same as modal rent
          const id = ev.currentTarget.dataset.id;
          const v = vehicles.find(x=>x.id===id);
          const user = window.Auth.getCurrentUser();
          if (!user || user.role !== 'client') { alert('Apenas clientes podem solicitar.'); return; }
          if (!v || v.status !== 'available') { alert('Ve√≠culo indispon√≠vel.'); return; }
          const orders = loadOrders();
          const order = {
            id: 'P-' + Date.now(),
            vehicleId: v.id,
            client: user.name || user.email,
            email: user.email,
            vehicle: v.brand + ' ' + v.model,
            start: new Date().toISOString().slice(0,10),
            end: new Date(Date.now() + 2*24*3600*1000).toISOString().slice(0,10),
            status: 'Pendente'
          };
          orders.push(order);
          saveOrders(orders);
          alert('Pedido criado com sucesso.');
        }

        // admin panel open
        fabAdd.addEventListener('click', function(){
          openAdminModal();
        });
        openAdminPanel.addEventListener('click', function(){
          openAdminModal();
        });

        // modal open/close helpers
        function openView(){ viewModal.classList.add('active'); viewModal.setAttribute('aria-hidden','false'); }
        function closeView(){ viewModal.classList.remove('active'); viewModal.setAttribute('aria-hidden','true'); }
        viewClose.addEventListener('click', closeView);
        viewModal.addEventListener('click', (e)=>{ if (e.target === viewModal) closeView(); });

        function openAdminModal(editId){
          // prepare form for create or edit
          if (editId) {
            const v = vehicles.find(x=>x.id===editId);
            if (v){
              vehicleIdInput.value = v.id;
              brandInput.value = v.brand;
              modelInput.value = v.model;
              yearInput.value = v.year;
              plateInput.value = v.plate;
              priceInput.value = v.price || '';
              statusSelect.value = v.status || 'available';
              imagePreview.src = v.image || placeholderDataURL();
              adminModal.querySelector('#adminModalTitle').textContent = 'Editar Ve√≠culo';
            }
          } else {
            vehicleForm.reset();
            vehicleIdInput.value = '';
            imagePreview.src = '';
            adminModal.querySelector('#adminModalTitle').textContent = 'Novo Ve√≠culo';
          }
          refreshAdminTable();
          adminModal.classList.add('active');
          adminModal.setAttribute('aria-hidden','false');
        }
        function closeAdminModal(){ adminModal.classList.remove('active'); adminModal.setAttribute('aria-hidden','true'); }
        adminClose.addEventListener('click', closeAdminModal);
        adminModal.addEventListener('click', (e)=>{ if (e.target === adminModal) closeAdminModal(); });
        document.getElementById('adminCancel').addEventListener('click', closeAdminModal);

        // confirm delete modal
        function openConfirm(){ confirmModal.classList.add('active'); confirmModal.setAttribute('aria-hidden','false'); }
        function closeConfirm(){ confirmModal.classList.remove('active'); confirmModal.setAttribute('aria-hidden','true'); toDeleteId = null; }
        confirmClose.addEventListener('click', closeConfirm);
        confirmCancel.addEventListener('click', closeConfirm);
        confirmModal.addEventListener('click',(e)=>{ if (e.target===confirmModal) closeConfirm(); });

        confirmDelete.addEventListener('click', function(){
          if (!toDeleteId) { closeConfirm(); return; }
          const idx = vehicles.findIndex(v=>v.id===toDeleteId);
          if (idx !== -1) vehicles.splice(idx,1);
          saveVehicles(vehicles);
          refreshAll();
          closeConfirm();
        });

        // admin table actions
        function onAdminTableAction(ev){
          const id = ev.currentTarget.dataset.id;
          const act = ev.currentTarget.dataset.act;
          if (act === 'edit') openAdminModal(id);
          else if (act === 'del') { toDeleteId = id; openConfirm(); }
        }

        // form submit create/edit
        vehicleForm.addEventListener('submit', async function(ev){
          ev.preventDefault();
          const id = vehicleIdInput.value;
          const brand = brandInput.value.trim();
          const model = modelInput.value.trim();
          const year = parseInt(yearInput.value,10);
          const plate = plateInput.value.trim();
          const price = priceInput.value ? parseFloat(priceInput.value) : null;
          const status = statusSelect.value;
          let imageData = imagePreview.src && imagePreview.src !== '' ? imagePreview.src : '';
          if (imageInput.files && imageInput.files[0]) {
            imageData = await fileToDataUrl(imageInput.files[0]);
          }
          if (!brand || !model || !year || !plate) { alert('Preencha marca, modelo, ano e placa.'); return; }
          if (id) {
            const idx = vehicles.findIndex(v=>v.id===id);
            if (idx !== -1) vehicles[idx] = { ...vehicles[idx], brand, model, year, plate, price, status, image: imageData };
          } else {
            const newV = { id: 'V-' + Date.now(), brand, model, year, plate, price, status, image: imageData };
            vehicles.unshift(newV);
          }
          saveVehicles(vehicles);
          refreshAll();
          closeAdminModal();
        });

        imageInput.addEventListener('change', async function(){
          if (!imageInput.files || !imageInput.files[0]) return;
          const d = await fileToDataUrl(imageInput.files[0]);
          imagePreview.src = d;
        });

        // admin table refresh and full refresh helper
        function refreshAll(){
          vehicles = loadVehicles();
          render();
          refreshAdminTable();
        }

        // initial render / helpers
        refreshAll();

        // small keyboard ESC to close modals
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape') {
            closeView();
            closeAdminModal();
            closeConfirm();
          }
        });

      })();
    </script>

    <!-- include your dashboard behaviour script if needed -->
    <script type="module" src="js/dashboard.js"></script>
  </body>
</html>